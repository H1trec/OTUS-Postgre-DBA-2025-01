## Нагрузочное тестирование и тюнинг PostgreSQL  
### Установил PostgreSQL 15 на виртуальную машину:
```
daemom@OVM:~$ pg_lsclusters
Ver Cluster Port Status Owner    Data directory              Log file
15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log
```
### Настройка PostgreSQL

1. На сайте https://www.pgconfig.org/ ввел параметры виртульной машины и получил необходимые настройки для  PostgreSQL:
* Пареметры VM:
![NEWVOLUME](https://github.com/H1trec/OTUS-Postgre-DBA-2025-01//blob/main/vmconfig.JPG?raw=true)
* Полученные параметры для  PostgreSQL:
```
-- Generated by PGConfig 3.1.4 (1fe6d98dedcaad1d0a114617cfd08b4fed1d8a01)
-- https://api.pgconfig.org/v1/tuning/get-config?format=alter_system&include_pgbadger=true&log_format=csvlog&max_connections=100&pg_version=15&environment_name=DW&total_ram=8GB&cpus=2&drive_type=HDD&arch=x86-64&os_type=linux

-- Memory Configuration
ALTER SYSTEM SET shared_buffers TO '2GB';
ALTER SYSTEM SET effective_cache_size TO '6GB';
ALTER SYSTEM SET work_mem TO '41MB';
ALTER SYSTEM SET maintenance_work_mem TO '410MB';

-- Checkpoint Related Configuration
ALTER SYSTEM SET min_wal_size TO '2GB';
ALTER SYSTEM SET max_wal_size TO '3GB';
ALTER SYSTEM SET checkpoint_completion_target TO '0.9';
ALTER SYSTEM SET wal_buffers TO '-1';

-- Network Related Configuration
ALTER SYSTEM SET listen_addresses TO '*';
ALTER SYSTEM SET max_connections TO '100';

-- Storage Configuration
ALTER SYSTEM SET random_page_cost TO '4.0';
ALTER SYSTEM SET effective_io_concurrency TO '2';

-- Worker Processes Configuration
ALTER SYSTEM SET max_worker_processes TO '8';
ALTER SYSTEM SET max_parallel_workers_per_gather TO '2';
ALTER SYSTEM SET max_parallel_workers TO '2';

-- Logging configuration for pgbadger
ALTER SYSTEM SET logging_collector TO 'on';
ALTER SYSTEM SET log_checkpoints TO 'on';
ALTER SYSTEM SET log_connections TO 'on';
ALTER SYSTEM SET log_disconnections TO 'on';
ALTER SYSTEM SET log_lock_waits TO 'on';
ALTER SYSTEM SET log_temp_files TO '0';
ALTER SYSTEM SET lc_messages TO 'C';

-- Adjust the minimum time to collect the data
ALTER SYSTEM SET log_min_duration_statement TO '10s';
ALTER SYSTEM SET log_autovacuum_min_duration TO '0';

-- CSV Configuration
ALTER SYSTEM SET log_destination TO 'csvlog';
```
Применил все параметры к установленому PostgreSQL.

### Подготовка pgbench
```
daemom@OVM:~$ sudo -u postgres pgbench -i -s 100 postgres
dropping old tables...
creating tables...
generating data (client-side)...
10000000 of 10000000 tuples (100%) done (elapsed 49.23 s, remaining 0.00 s)
vacuuming...
creating primary keys...
done in 69.43 s (drop tables 0.06 s, create tables 0.05 s, client-side generate 49.62 s, vacuum 0.24 s, primary keys 19.46 s).
```
Применил параметр -s 100 для увеличения количества записей в таблице pgbench_accounts до 10000000.
### Запуск pgbench
```
daemom@OVM:~$ sudo -u postgres pgbench -c 90 -j 8 -P 60 -T 600
pgbench (15.12 (Ubuntu 15.12-1.pgdg24.10+1))
starting vacuum...end.
progress: 60.0 s, 545.6 tps, lat 163.754 ms stddev 99.654, 0 failed
progress: 120.0 s, 573.2 tps, lat 157.116 ms stddev 88.921, 0 failed
progress: 180.0 s, 569.3 tps, lat 157.900 ms stddev 88.927, 0 failed
progress: 240.0 s, 583.3 tps, lat 154.329 ms stddev 86.588, 0 failed
progress: 300.0 s, 595.0 tps, lat 151.257 ms stddev 86.291, 0 failed
progress: 360.0 s, 623.9 tps, lat 144.061 ms stddev 81.671, 0 failed
progress: 420.0 s, 557.3 tps, lat 161.613 ms stddev 91.865, 0 failed
progress: 480.0 s, 575.2 tps, lat 156.362 ms stddev 90.446, 0 failed
progress: 540.0 s, 580.4 tps, lat 154.848 ms stddev 88.521, 0 failed
progress: 600.0 s, 588.5 tps, lat 152.961 ms stddev 87.924, 0 failed
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 100
query mode: simple
number of clients: 90
number of threads: 8
maximum number of tries: 1
duration: 600 s
number of transactions actually processed: 347587
number of failed transactions: 0 (0.000%)
latency average = 155.293 ms
latency stddev = 89.328 ms
initial connection time = 282.764 ms
tps = 578.930852 (without initial connection time)
```
Выставил параметры: 
* -c 90 - количество клиентов, установлено исходя из максимального значения в 100
* -j 8 - количество потоков, установлено для большей нагрузки
* -P 60 - время в секундах через которое выводить отчет
* -T 600 - время выполнения 600 секунд

Итого получилось среднее занчение tps = 578.930852. Хотя по отчету видно, что пиковое значение достигало 623.9 tps.

